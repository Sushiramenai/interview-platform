<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interview Platform - Welcome</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 40px 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 30px;
        }
        .intro-content {
            line-height: 1.6;
            color: #555;
            margin-bottom: 30px;
        }
        .start-btn {
            background-color: #007bff;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 6px;
            font-size: 18px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .start-btn:hover {
            background-color: #0056b3;
        }
        .info-box {
            background-color: #f8f9fa;
            border-left: 4px solid #007bff;
            padding: 20px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Welcome to Your Interview</h1>
        <div id="intro-content" class="intro-content">
            Loading...
        </div>
        <div class="info-box">
            <h3>What to Expect:</h3>
            <ul>
                <li>You'll join a Google Meet session with our AI interviewer</li>
                <li>The interview will be recorded for review</li>
                <li>Questions will be tailored to the role you're applying for</li>
                <li>The session typically takes 30-45 minutes</li>
            </ul>
        </div>
        <button class="start-btn" onclick="startInterview()">Start Interview</button>
    </div>

    <script>
        async function loadIntroContent() {
            try {
                const response = await fetch('/api/settings');
                const settings = await response.json();
                const content = settings.intro_content || '# Welcome\n\nWe look forward to speaking with you!';
                document.getElementById('intro-content').innerHTML = marked.parse(content);
            } catch (error) {
                console.error('Error loading intro content:', error);
            }
        }

        async function startInterview() {
            const params = new URLSearchParams(window.location.search);
            const role = params.get('role') || 'general';
            
            // Get candidate information
            const candidateName = prompt('Please enter your full name:');
            if (!candidateName) return;
            
            const candidateEmail = prompt('Please enter your email address:');
            if (!candidateEmail) return;
            
            // Check if candidate has already attempted this interview
            try {
                const statusResponse = await fetch(`/api/interview/check-status?email=${encodeURIComponent(candidateEmail)}&role=${encodeURIComponent(role)}`);
                const status = await statusResponse.json();
                
                if (!status.canStart) {
                    alert(status.message || 'You have already attempted this interview. Multiple attempts are not allowed.');
                    
                    // Show status information
                    document.querySelector('.container').innerHTML = `
                        <h1>Interview Status</h1>
                        <div class="info-box" style="border-color: #dc3545;">
                            <h3>Interview Already Attempted</h3>
                            <p>${status.message}</p>
                            ${status.completedAt ? `<p>Completed on: ${new Date(status.completedAt).toLocaleString()}</p>` : ''}
                            ${status.score ? `<p>Score: ${status.score}/10</p>` : ''}
                        </div>
                    `;
                    return;
                }
            } catch (error) {
                console.error('Error checking interview status:', error);
            }
            
            // Start automated interview
            try {
                const response = await fetch('/api/interview/automated/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        candidateName,
                        email: candidateEmail,
                        role
                    })
                });
                
                if (response.ok) {
                    const session = await response.json();
                    
                    // Check interview mode
                    if (session.mode === 'self-hosted-bot') {
                        // Self-hosted AI bot interview
                        alert('Your AI-powered interview is ready! The AI interviewer will join the Google Meet room shortly after you.');
                        
                        // Open Google Meet in new tab
                        window.open(session.meetUrl, '_blank');
                        
                        // Show AI interview instructions
                        document.querySelector('.container').innerHTML = `
                            <h1>AI Interview Started</h1>
                            <div class="info-box" style="border-color: #28a745;">
                                <p>Your Google Meet interview has been opened in a new window/tab.</p>
                                <p>If the window didn't open, <a href="${session.meetUrl}" target="_blank">click here to join the meeting</a>.</p>
                                <br>
                                <h3>ðŸ¤– AI Interview Process:</h3>
                                <ul>
                                    <li>Join the Google Meet room now</li>
                                    <li>The AI interviewer will join in about 10 seconds</li>
                                    <li>The AI will ask questions using natural voice</li>
                                    <li>Speak clearly when answering each question</li>
                                    <li>Wait for the AI to finish speaking before responding</li>
                                    <li>The interview will last 30-45 minutes</li>
                                </ul>
                                
                                <div style="margin-top: 20px; padding: 15px; background: #d4edda; color: #155724; border-radius: 5px;">
                                    <strong>âœ… AI Bot Active</strong> - Your interview will be conducted by our AI interviewer with voice synthesis.
                                </div>
                            </div>
                        `;
                    } else if (session.mode === 'manual') {
                        // Manual interview without bot
                        alert('Interview ready! You will now join a Google Meet room. An interviewer will conduct your interview using the prepared questions.');
                        
                        // Open Google Meet in new tab
                        window.open(session.meetUrl, '_blank');
                        
                        // Show manual interview instructions
                        document.querySelector('.container').innerHTML = `
                            <h1>Interview Started (Manual Mode)</h1>
                            <div class="info-box">
                                <p>Your Google Meet interview has been opened in a new window/tab.</p>
                                <p>If the window didn't open, <a href="${session.meetUrl}" target="_blank">click here to join the meeting</a>.</p>
                                <br>
                                <h3>Interview Process:</h3>
                                <ul>
                                    <li>A human interviewer will join the call</li>
                                    <li>They have access to prepared questions for your role</li>
                                    <li>The interview will last 30-45 minutes</li>
                                    <li>Please ensure your camera and microphone work</li>
                                    <li>This is a one-time interview - no redos allowed</li>
                                </ul>
                                
                                ${session.interviewGuideUrl ? `
                                <br>
                                <p><strong>For the interviewer:</strong> <a href="${session.interviewGuideUrl}" target="_blank">View Interview Guide</a></p>
                                ` : ''}
                            </div>
                        `;
                    } else {
                        // Full automated interview with bot
                        alert(session.instructions || 'Your interview is ready! You will now be redirected to the Google Meet room.');
                        
                        // Open Google Meet in new tab/window
                        window.open(session.meetUrl, '_blank');
                        
                        // Show completion message
                        document.querySelector('.container').innerHTML = `
                            <h1>Interview Started</h1>
                            <div class="info-box">
                                <p>Your Google Meet interview has been opened in a new window/tab.</p>
                                <p>If the window didn't open, <a href="${session.meetUrl}" target="_blank">click here to join the meeting</a>.</p>
                                <br>
                                <h3>Important Notes:</h3>
                                <ul>
                                    <li>The AI interviewer will join the meeting shortly</li>
                                    <li>Please ensure your camera and microphone are enabled</li>
                                    <li>The interview will be recorded for evaluation</li>
                                    <li>Once you start, you cannot redo the interview</li>
                                </ul>
                            </div>
                        `;
                    }
                } else {
                    // Get error details
                    let errorMsg = 'Failed to start interview';
                    try {
                        const errorData = await response.json();
                        errorMsg = errorData.error || errorMsg;
                        console.error('Interview start error:', errorData);
                    } catch (e) {
                        console.error('Failed to parse error response');
                    }
                    alert(errorMsg + '. Please try again.');
                }
            } catch (error) {
                console.error('Error starting interview:', error);
                alert('Error starting interview: ' + error.message);
            }
        }

        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        loadIntroContent();
    </script>
</body>
</html>
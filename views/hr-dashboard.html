<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Senbird Interview System - HR Dashboard</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@700&family=Noto+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Styles -->
    <link rel="stylesheet" href="/css/design-system.css">
    <style>
        /* Page Specific Styles */
        body {
            background: linear-gradient(135deg, var(--light) 0%, var(--white) 100%);
            min-height: 100vh;
        }
        
        /* Header Styles */
        .platform-header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: var(--space-md) 0;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.05);
        }
        
        /* Hero Section */
        .hero {
            position: relative;
            padding: var(--space-3xl) 0;
            overflow: hidden;
        }
        
        .hero::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -10%;
            width: 800px;
            height: 800px;
            background: radial-gradient(circle, var(--primary) 0%, transparent 70%);
            opacity: 0.05;
            animation: float 20s ease-in-out infinite;
        }
        
        .hero-content {
            position: relative;
            z-index: 1;
        }
        
        .hero-title {
            background: linear-gradient(135deg, var(--dark) 0%, var(--primary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: var(--space-lg);
        }
        
        .hero-subtitle {
            font-size: 1.25rem;
            color: var(--dark-70);
            max-width: 600px;
            margin: 0 auto var(--space-2xl);
        }
        
        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--space-lg);
            margin-bottom: var(--space-3xl);
        }
        
        .stat-card {
            background: var(--white);
            border-radius: var(--radius-lg);
            padding: var(--space-xl);
            box-shadow: var(--shadow-md);
            transition: all var(--transition-base);
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, var(--primary) 0%, var(--accent-forest) 50%, var(--warm-brown) 100%);
        }
        
        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-xl);
        }
        
        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            margin-bottom: var(--space-md);
        }
        
        .stat-icon.primary {
            background: rgba(206, 42, 43, 0.1);
            color: var(--primary);
        }
        
        .stat-icon.success {
            background: rgba(159, 181, 149, 0.15);
            color: var(--accent-forest);
        }
        
        .stat-icon.warning {
            background: rgba(255, 179, 128, 0.1);
            color: var(--warning);
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--dark);
            font-family: var(--font-display);
        }
        
        .stat-label {
            font-size: 0.875rem;
            color: var(--dark-50);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        /* Create Interview Section */
        .create-section {
            background: var(--white);
            border-radius: var(--radius-xl);
            padding: var(--space-2xl);
            box-shadow: var(--shadow-lg);
            margin-bottom: var(--space-3xl);
            position: relative;
            overflow: hidden;
        }
        
        .create-section::after {
            content: '';
            position: absolute;
            bottom: -50px;
            right: -50px;
            width: 200px;
            height: 200px;
            background: radial-gradient(circle, var(--peach) 0%, transparent 70%);
            opacity: 0.1;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--space-lg);
            margin-bottom: var(--space-xl);
        }
        
        /* Interview List */
        .interview-list {
            background: var(--white);
            border-radius: var(--radius-xl);
            padding: var(--space-2xl);
            box-shadow: var(--shadow-lg);
        }
        
        .interview-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--space-lg);
            border-radius: var(--radius-md);
            transition: all var(--transition-base);
            margin-bottom: var(--space-md);
            border: 1px solid var(--dark-05);
        }
        
        .interview-item:hover {
            background: var(--light);
            border-color: var(--primary);
            transform: translateX(4px);
        }
        
        .interview-info {
            flex: 1;
        }
        
        .interview-name {
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 0.25rem;
        }
        
        .interview-details {
            font-size: 0.875rem;
            color: var(--dark-50);
        }
        
        .interview-actions {
            display: flex;
            gap: var(--space-sm);
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(50, 50, 50, 0.8);
            backdrop-filter: blur(10px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: var(--space-lg);
            overflow-y: auto;
        }
        
        .modal.active {
            display: flex;
            animation: fadeIn var(--transition-base);
        }
        
        body.modal-open {
            overflow: hidden;
        }
        
        .modal-content {
            background: var(--white);
            border-radius: var(--radius-xl);
            padding: var(--space-2xl);
            max-width: 500px;
            width: 100%;
            position: relative;
            animation: scaleIn var(--transition-spring);
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            margin: auto;
        }
        
        .modal-scrollable {
            overflow-y: auto;
            flex: 1;
            padding-right: 10px;
            margin-right: -10px;
        }
        
        .modal-close {
            position: absolute;
            top: var(--space-lg);
            right: var(--space-lg);
            width: 32px;
            height: 32px;
            border-radius: var(--radius-full);
            border: none;
            background: var(--dark-05);
            color: var(--dark);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-base);
        }
        
        .modal-close:hover {
            background: var(--dark-10);
        }
        
        /* Alert Styles */
        .alert {
            padding: 12px 16px;
            border-radius: var(--radius-md);
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .alert-success {
            background: rgba(103, 137, 72, 0.1);
            color: var(--success);
            border: 1px solid rgba(103, 137, 72, 0.2);
        }
        
        .alert-warning {
            background: rgba(246, 195, 68, 0.1);
            color: var(--warning);
            border: 1px solid rgba(246, 195, 68, 0.2);
        }
        
        .alert-danger {
            background: rgba(206, 42, 43, 0.1);
            color: var(--error);
            border: 1px solid rgba(206, 42, 43, 0.2);
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: var(--space-3xl);
        }
        
        .empty-icon {
            width: 120px;
            height: 120px;
            margin: 0 auto var(--space-xl);
            background: var(--light);
            border-radius: var(--radius-full);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            color: var(--dark-20);
        }
        
        /* Loading State */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        
        .loading-overlay.active {
            display: flex;
        }
        
        .loading-content {
            text-align: center;
        }
        
        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid var(--dark-10);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto var(--space-lg);
        }
        
        /* Decorative Elements */
        .decoration-1 {
            position: absolute;
            top: 20%;
            left: -100px;
            width: 200px;
            height: 200px;
            background: radial-gradient(circle, var(--accent-sage) 0%, transparent 70%);
            opacity: 0.15;
            animation: float 15s ease-in-out infinite;
        }
        
        .decoration-2 {
            position: absolute;
            bottom: 10%;
            right: -100px;
            width: 300px;
            height: 300px;
            background: radial-gradient(circle, var(--golden) 0%, transparent 70%);
            opacity: 0.1;
            animation: float 20s ease-in-out infinite reverse;
        }
        
        /* Advanced Settings */
        .advanced-settings {
            background: var(--light);
            border-radius: var(--radius-lg);
            padding: 0;
            margin-top: var(--space-xl);
            border: 1px solid var(--dark-05);
        }
        
        .advanced-toggle {
            padding: var(--space-md) var(--space-lg);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            font-weight: 600;
            color: var(--dark);
            transition: all var(--transition-base);
            list-style: none;
        }
        
        .advanced-toggle:hover {
            color: var(--primary);
        }
        
        .advanced-toggle::marker {
            content: '';
        }
        
        .advanced-content {
            padding: var(--space-lg);
            padding-top: 0;
        }
        
        .settings-section {
            margin-bottom: var(--space-xl);
            padding: var(--space-lg);
            background: var(--white);
            border-radius: var(--radius-md);
            border: 1px solid var(--dark-05);
        }
        
        .settings-section h4 {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            margin-bottom: var(--space-md);
            color: var(--dark);
            font-size: 1.125rem;
        }
        
        .question-item {
            position: relative;
        }
        
        .question-input {
            padding-right: 40px;
        }
        
        .remove-question {
            position: absolute;
            right: 10px;
            top: 35px;
            background: none;
            border: none;
            color: var(--error);
            cursor: pointer;
            padding: 5px;
            opacity: 0.6;
            transition: opacity var(--transition-base);
        }
        
        .remove-question:hover {
            opacity: 1;
        }
        
        /* Template List Styles */
        .template-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--space-md);
            border-radius: var(--radius-md);
            background: var(--light);
            margin-bottom: var(--space-sm);
            transition: all var(--transition-base);
        }
        
        .template-item:hover {
            background: var(--dark-05);
            transform: translateX(4px);
        }
        
        .template-info {
            flex: 1;
        }
        
        .template-name {
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 0.25rem;
        }
        
        .template-questions {
            font-size: 0.875rem;
            color: var(--dark-50);
        }
        
        .template-actions {
            display: flex;
            gap: var(--space-sm);
        }
        
        /* Utility Classes */
        .d-flex {
            display: flex;
        }
        
        .justify-content-between {
            justify-content: space-between;
        }
        
        .align-items-center {
            align-items: center;
        }
        
        .mb-4 {
            margin-bottom: var(--space-lg) !important;
        }
        
        /* Template Cards */
        .template-card {
            background: var(--white);
            border: 2px solid var(--dark-05);
            border-radius: var(--radius-lg);
            padding: var(--space-xl);
            transition: all var(--transition-base);
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        
        .template-card:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(210, 58, 47, 0.1), 0 4px 12px rgba(107, 142, 90, 0.15);
        }
        
        .template-card-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: var(--space-md);
        }
        
        .template-card-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: var(--space-sm);
        }
        
        .template-card-meta {
            display: flex;
            gap: var(--space-md);
            font-size: 0.875rem;
            color: var(--dark-50);
            margin-bottom: var(--space-md);
        }
        
        .template-card-meta-item {
            display: flex;
            align-items: center;
            gap: var(--space-xs);
        }
        
        .template-card-description {
            font-size: 0.875rem;
            color: var(--dark-70);
            line-height: 1.6;
            margin-bottom: var(--space-md);
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
        }
        
        .template-card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: var(--space-lg);
            padding-top: var(--space-md);
            border-top: 1px solid var(--dark-05);
        }
        
        .template-card-actions {
            display: flex;
            gap: var(--space-sm);
        }
        
        .question-number {
            min-width: 28px;
            text-align: center;
            font-weight: 600;
        }
        
        .ml-3 {
            margin-left: var(--space-md);
        }
        
        .gap-2 {
            gap: var(--space-sm);
        }
        
        .flex-1 {
            flex: 1;
        }
        
        /* Badge Styles */
        .badge {
            display: inline-block;
            padding: 4px 12px;
            font-size: 0.75rem;
            font-weight: 600;
            border-radius: var(--radius-full);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .badge-secondary {
            background: linear-gradient(135deg, var(--accent-sage), var(--accent-forest));
            color: var(--white);
            font-weight: 600;
            box-shadow: 0 2px 4px rgba(107, 142, 90, 0.2);
        }
        
        /* Premium Green Accents */
        .btn-primary:hover {
            box-shadow: 0 4px 12px rgba(210, 58, 47, 0.3), 0 2px 6px rgba(107, 142, 90, 0.2);
        }
        
        .form-control:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(210, 58, 47, 0.1), 0 0 0 6px rgba(159, 181, 149, 0.1);
        }
        
        .interview-item:hover {
            background: linear-gradient(to right, var(--light), rgba(159, 181, 149, 0.05));
            border-color: var(--primary);
            box-shadow: inset 3px 0 0 var(--accent-forest);
        }
        
        .tab-button.active {
            position: relative;
        }
        
        .tab-button.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 20%;
            right: 20%;
            height: 3px;
            background: linear-gradient(90deg, transparent, var(--accent-forest), transparent);
            opacity: 0.5;
        }
    </style>
</head>
<body>
    <!-- Decorative Elements -->
    <div class="decoration-1"></div>
    <div class="decoration-2"></div>
    
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <p class="text-muted">Creating interview...</p>
        </div>
    </div>
    
    <!-- Header with Logo -->
    <header class="platform-header">
        <div class="container">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <a href="/" class="logo">
                    <img src="/images/logo.png" alt="SenbirdTea" class="logo-img">
                    <div class="logo-text">
                        <span>SENBIRD</span>
                    </div>
                </a>
                <button class="btn btn-secondary" onclick="showSettingsModal()">
                    <i class="fas fa-cog"></i> Settings
                </button>
            </div>
        </div>
    </header>
    
    <!-- Hero Section -->
    <section class="hero">
        <div class="container">
            <div class="hero-content text-center">
                <h1 class="hero-title animate-slideDown">Senbird Interview System</h1>
                <p class="hero-subtitle animate-slideUp">
                    Transform your hiring process with intelligent AI-powered interviews
                </p>
            </div>
        </div>
    </section>
    
    <!-- Main Dashboard Tabs -->
    <section class="container">
        <div class="dashboard-tabs animate-fadeIn" style="margin-bottom: var(--space-2xl);">
            <div class="tabs" style="display: flex; gap: var(--space-sm); border-bottom: 2px solid var(--dark-10); margin-bottom: var(--space-xl);">
                <button class="tab-button active" onclick="switchTab('positions')" data-tab="positions" style="padding: var(--space-md) var(--space-xl); background: none; border: none; font-weight: 600; color: var(--primary); border-bottom: 3px solid var(--primary); margin-bottom: -2px; cursor: pointer;">
                    <i class="fas fa-briefcase"></i> Position Templates
                </button>
                <button class="tab-button" onclick="switchTab('interviews')" data-tab="interviews" style="padding: var(--space-md) var(--space-xl); background: none; border: none; font-weight: 600; color: var(--dark-50); cursor: pointer;">
                    <i class="fas fa-user-tie"></i> Create Interview
                </button>
                <button class="tab-button" onclick="switchTab('history')" data-tab="history" style="padding: var(--space-md) var(--space-xl); background: none; border: none; font-weight: 600; color: var(--dark-50); cursor: pointer;">
                    <i class="fas fa-history"></i> Interview History
                </button>
            </div>
        </div>
    </section>
    
    <!-- Position Templates Tab -->
    <section class="container tab-content" id="positionsTab">
        <div class="create-section animate-slideUp">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-xl);">
                <div>
                    <h2>Position Templates</h2>
                    <p class="text-muted">Create and manage interview templates for different positions</p>
                </div>
                <button class="btn btn-primary" onclick="showCreateTemplateForm()">
                    <i class="fas fa-plus"></i> Create New Template
                </button>
            </div>
            
            <div id="templatesList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: var(--space-xl);">
                <!-- Templates will be loaded here -->
            </div>
        </div>
    </section>
    
    <!-- Create Interview Tab -->
    <section class="container tab-content" id="interviewsTab" style="display: none;">
        <div class="stats-grid animate-fadeIn" style="margin-bottom: var(--space-2xl);">
            <div class="stat-card">
                <div class="stat-icon primary">
                    <i class="fas fa-users"></i>
                </div>
                <div class="stat-value" id="totalInterviews">0</div>
                <div class="stat-label">Total Interviews</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon success">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="stat-value" id="completedInterviews">0</div>
                <div class="stat-label">Completed</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon warning">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="stat-value" id="pendingInterviews">0</div>
                <div class="stat-label">Pending</div>
            </div>
        </div>
        
        <div class="create-section animate-slideUp">
            <h2>Create New Interview</h2>
            <p class="text-muted mb-4">Schedule an AI-powered interview in seconds</p>
            
            <form id="createInterviewForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Candidate Name</label>
                        <input type="text" class="form-control" id="candidateName" required 
                               placeholder="John Smith">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Candidate Email</label>
                        <input type="email" class="form-control" id="candidateEmail" required 
                               placeholder="john@example.com">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Position</label>
                        <select class="form-control" id="role" required>
                            <option value="">Select a position template...</option>
                        </select>
                        <small class="text-muted">Create position templates using the button above</small>
                    </div>
                </div>
                
                <!-- Advanced Settings Accordion -->
                <details class="advanced-settings mb-4">
                    <summary class="advanced-toggle">
                        <i class="fas fa-cog"></i>
                        Advanced Settings
                    </summary>
                    
                    <div class="advanced-content">
                        <!-- Voice Selection -->
                        <div class="settings-section">
                            <h4><i class="fas fa-microphone"></i> Voice Settings</h4>
                            <div class="form-group">
                                <label class="form-label">Interview Voice</label>
                                <select class="form-control" id="voiceSelect">
                                    <option value="EXAVITQu4vr4xnSDxMaL">Rachel - Professional Female</option>
                                    <option value="pNInz6obpgDQGcFmaJgB">Adam - Professional Male</option>
                                    <option value="21m00Tcm4TlvDq8ikWAM">Domi - Warm Female</option>
                                    <option value="AZnzlk1XvdvUeBnXmlld">Sam - Friendly Male</option>
                                    <option value="ThT5KcBeYPX3keUQqHPh">Dorothy - British Female</option>
                                    <option value="IKne3meq5aSn9XLyUdCD">Charlie - Australian Male</option>
                                </select>
                                <button type="button" class="btn btn-sm btn-accent mt-2" onclick="testVoice()">
                                    <i class="fas fa-play"></i> Test Voice
                                </button>
                            </div>
                        </div>
                        
                        <!-- Question Customization -->
                        <div class="settings-section">
                            <h4><i class="fas fa-question-circle"></i> Interview Questions</h4>
                            <p class="text-muted mb-3">Customize the questions for this interview (leave empty for defaults)</p>
                            <div id="questionsContainer">
                                <div class="question-item mb-3">
                                    <label class="form-label">Question 1</label>
                                    <textarea class="form-control question-input" rows="2" 
                                              placeholder="Tell me about yourself and your professional background."></textarea>
                                </div>
                            </div>
                            <button type="button" class="btn btn-sm btn-accent" onclick="addQuestion()">
                                <i class="fas fa-plus"></i> Add Question
                            </button>
                        </div>
                    </div>
                </details>
                
                <button type="submit" class="btn btn-primary btn-lg">
                    <i class="fas fa-magic"></i>
                    Create Interview Link
                </button>
            </form>
        </div>
    </section>
    
    
    <!-- Interview History Tab -->
    <section class="container tab-content" id="historyTab" style="display: none;">
        <div class="interview-list animate-slideUp">
            <div class="card-header">
                <h3>Recent Interviews</h3>
            </div>
            
            <div id="interviewsList">
                <div class="empty-state">
                    <div class="empty-icon">
                        <i class="fas fa-calendar-plus"></i>
                    </div>
                    <h4>No interviews yet</h4>
                    <p class="text-muted">Create your first interview to get started</p>
                </div>
            </div>
        </div>
    </section>
    
    <!-- Success Modal -->
    <div class="modal" id="successModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal()">
                <i class="fas fa-times"></i>
            </button>
            
            <div class="text-center">
                <div class="stat-icon success" style="width: 80px; height: 80px; font-size: 2rem; margin: 0 auto var(--space-xl);">
                    <i class="fas fa-check"></i>
                </div>
                
                <h3>Interview Created!</h3>
                <p class="text-muted mb-4">Share this link with the candidate</p>
                
                <div class="form-group text-left">
                    <label class="form-label">Interview Link</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="interviewLink" readonly>
                    </div>
                </div>
                
                <button class="btn btn-primary" onclick="copyLink()">
                    <i class="fas fa-copy"></i>
                    Copy Link
                </button>
                <button class="btn btn-secondary" onclick="closeModal()">
                    Close
                </button>
            </div>
        </div>
    </div>
    
    <!-- Settings Modal -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeSettingsModal()">
                <i class="fas fa-times"></i>
            </button>
            
            <div class="text-center mb-4">
                <h3>API Settings</h3>
                <p class="text-muted">Configure your API keys for the interview system</p>
            </div>
            
            <form id="settingsForm">
                <div class="form-group">
                    <label class="form-label">OpenAI API Key</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="password" class="form-control" id="openAIKey" 
                               placeholder="Enter your OpenAI API key" style="flex: 1;">
                        <button type="button" class="btn btn-secondary" onclick="testAPIConnection('openai')" id="testOpenAIBtn">
                            <i class="fas fa-plug"></i> Test
                        </button>
                    </div>
                    <small class="text-muted">Used for AI-powered interview questions and analysis</small>
                    <div id="openaiTestResult" style="margin-top: 10px; display: none;"></div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">ElevenLabs API Key</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="password" class="form-control" id="elevenLabsKey" 
                               placeholder="Enter your ElevenLabs API key" style="flex: 1;">
                        <button type="button" class="btn btn-secondary" onclick="testAPIConnection('elevenlabs')" id="testElevenLabsBtn">
                            <i class="fas fa-plug"></i> Test
                        </button>
                    </div>
                    <small class="text-muted">Used for voice synthesis in interviews</small>
                    <div id="elevenlabsTestResult" style="margin-top: 10px; display: none;"></div>
                </div>
                
                <div class="text-center mt-4">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Save Settings
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closeSettingsModal()">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Template Management Modal -->
    <div class="modal" id="templateModal">
        <div class="modal-content" style="max-width: 1000px; max-height: 90vh; display: flex; flex-direction: column;">
            <button class="modal-close" onclick="closeTemplateModal()">
                <i class="fas fa-times"></i>
            </button>
            
            <div class="mb-4">
                <h3>Position Template Management</h3>
                <p class="text-muted">Create comprehensive interview templates with job descriptions and custom questions</p>
            </div>
            
            <div class="modal-scrollable" style="flex: 1; overflow-y: auto;">
                <!-- Template List View -->
                <div id="templatesListView">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h4>Your Position Templates</h4>
                        <button class="btn btn-primary" onclick="showCreateTemplate()">
                            <i class="fas fa-plus"></i> Create New Template
                        </button>
                    </div>
                    
                    <div id="templatesList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px;">
                        <div class="empty-state" style="grid-column: 1/-1; padding: 60px; text-align: center; background: var(--light); border-radius: var(--radius-lg);">
                            <i class="fas fa-folder-open" style="font-size: 4rem; color: var(--dark-20); margin-bottom: 20px; display: block;"></i>
                            <h4>No templates yet</h4>
                            <p class="text-muted">Create your first position template to streamline your interview process</p>
                        </div>
                    </div>
                </div>
                
                <!-- Create/Edit Template Form -->
                <div id="templateFormView" style="display: none;">
                    <div class="d-flex align-items-center mb-4">
                        <button class="btn btn-secondary btn-sm" onclick="backToTemplatesList()">
                            <i class="fas fa-arrow-left"></i> Back
                        </button>
                        <h4 class="mb-0 ml-3" id="templateFormTitle">Create New Position Template</h4>
                    </div>
                    
                    <form id="createTemplateForm">
                        <input type="hidden" id="editTemplateId">
                        
                        <div class="template-form-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <!-- Left Column -->
                            <div>
                                <div class="form-group">
                                    <label class="form-label">Position Title <span style="color: var(--error);">*</span></label>
                                    <input type="text" class="form-control" id="templatePosition" required
                                           placeholder="e.g., Senior Software Engineer">
                                    <small class="text-muted">This will appear in the interview invitation</small>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Department</label>
                                    <input type="text" class="form-control" id="templateDepartment"
                                           placeholder="e.g., Engineering, Marketing, Sales">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Experience Level</label>
                                    <select class="form-control" id="templateLevel">
                                        <option value="">Select level...</option>
                                        <option value="entry">Entry Level</option>
                                        <option value="mid">Mid Level</option>
                                        <option value="senior">Senior Level</option>
                                        <option value="lead">Lead/Principal</option>
                                        <option value="executive">Executive</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Interview Duration (minutes)</label>
                                    <input type="number" class="form-control" id="templateDuration" 
                                           placeholder="30" min="15" max="120" value="30">
                                </div>
                            </div>
                            
                            <!-- Right Column -->
                            <div>
                                <div class="form-group">
                                    <label class="form-label">Job Description <span style="color: var(--error);">*</span></label>
                                    <textarea class="form-control" id="templateJobDescription" rows="8" required
                                              placeholder="Paste the full job description here. This helps the AI understand the role and ask relevant questions.

Example:
We are looking for a Senior Software Engineer to join our team. The ideal candidate will have 5+ years of experience in full-stack development...

Responsibilities:
- Design and implement scalable web applications
- Lead code reviews and mentor junior developers
- Collaborate with product teams...

Requirements:
- Strong experience with React and Node.js
- Knowledge of cloud platforms (AWS/GCP)
- Excellent communication skills..."></textarea>
                                    <small class="text-muted">The AI will use this to tailor questions to the specific role</small>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Interview Questions Section -->
                        <div class="form-group" style="margin-top: 30px;">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <div>
                                    <label class="form-label mb-0">Interview Questions</label>
                                    <small class="text-muted d-block">Add specific questions you want the AI to ask</small>
                                </div>
                                <button type="button" class="btn btn-accent btn-sm" onclick="generateSuggestedQuestions()">
                                    <i class="fas fa-magic"></i> Generate Suggestions
                                </button>
                            </div>
                            
                            <div style="background: linear-gradient(135deg, var(--light), rgba(159, 181, 149, 0.05)); border: 1px solid rgba(159, 181, 149, 0.2); padding: 20px; border-radius: var(--radius-md); max-height: 400px; overflow-y: auto;">
                                <div id="templateQuestionsContainer">
                                    <div class="question-item mb-3">
                                        <div class="d-flex align-items-start gap-2">
                                            <span class="question-number" style="background: linear-gradient(135deg, var(--primary), var(--accent-forest)); color: white; padding: 4px 10px; border-radius: var(--radius-full); font-size: 0.875rem; margin-top: 8px;">1</span>
                                            <textarea class="form-control template-question-input flex-1" rows="2" required
                                                      placeholder="e.g., Tell me about your experience with [relevant technology/skill]"></textarea>
                                            <button type="button" class="btn btn-sm btn-light" onclick="removeTemplateQuestion(this)" style="margin-top: 8px;">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <button type="button" class="btn btn-accent mt-3" onclick="addTemplateQuestion()">
                                    <i class="fas fa-plus"></i> Add Another Question
                                </button>
                            </div>
                        </div>
                        
                        <div class="text-center mt-4" style="border-top: 1px solid var(--dark-10); padding-top: 20px;">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="fas fa-save"></i> Save Template
                            </button>
                            <button type="button" class="btn btn-secondary btn-lg" onclick="cancelTemplateEdit()">
                                Cancel
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadInterviews();
            setupEventListeners();
            loadTemplates();
            loadSettings();
            loadGuidelines();
            renderTemplateCards();
        });
        
        // Setup event listeners
        function setupEventListeners() {
            document.getElementById('createInterviewForm').addEventListener('submit', createInterview);
            document.getElementById('settingsForm').addEventListener('submit', saveSettings);
            document.getElementById('createTemplateForm').addEventListener('submit', saveTemplate);
            document.getElementById('role').addEventListener('change', loadTemplateQuestions);
            // Guidelines form removed - using optimal defaults
            // Follow-up frequency removed - using optimal defaults
        }
        
        // Tab switching
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.style.display = 'none';
            });
            
            // Show selected tab
            document.getElementById(tabName + 'Tab').style.display = 'block';
            
            // Update button states
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
                btn.style.color = 'var(--dark-50)';
                btn.style.borderBottom = 'none';
                btn.style.marginBottom = '0';
            });
            
            const activeBtn = document.querySelector(`[data-tab="${tabName}"]`);
            activeBtn.classList.add('active');
            activeBtn.style.color = 'var(--primary)';
            activeBtn.style.borderBottom = '3px solid var(--primary)';
            activeBtn.style.marginBottom = '-2px';
            
            // Load data for specific tabs
            if (tabName === 'positions') {
                renderTemplateCards();
            } else if (tabName === 'history') {
                loadInterviews();
            }
        }
        
        // Render template cards in the positions tab
        function renderTemplateCards() {
            const container = document.getElementById('templatesList');
            
            if (templates.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="grid-column: 1/-1; padding: 60px; text-align: center; background: var(--light); border-radius: var(--radius-lg);">
                        <i class="fas fa-folder-open" style="font-size: 4rem; color: var(--dark-20); margin-bottom: 20px; display: block;"></i>
                        <h4>No position templates yet</h4>
                        <p class="text-muted">Create your first template to streamline interviews</p>
                        <button class="btn btn-primary mt-3" onclick="showTemplateModal()">
                            <i class="fas fa-plus"></i> Create Template
                        </button>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = templates.map(template => `
                <div class="template-card">
                    <div class="template-card-header">
                        <div>
                            <h3 class="template-card-title">${template.position}</h3>
                            ${template.department ? `<span class="badge badge-secondary">${template.department}</span>` : ''}
                        </div>
                    </div>
                    
                    <div class="template-card-meta">
                        ${template.level ? `
                        <div class="template-card-meta-item">
                            <i class="fas fa-layer-group"></i>
                            <span>${getLevelLabel(template.level)}</span>
                        </div>
                        ` : ''}
                        <div class="template-card-meta-item">
                            <i class="fas fa-clock"></i>
                            <span>${template.duration || 30} min</span>
                        </div>
                        <div class="template-card-meta-item">
                            <i class="fas fa-question-circle"></i>
                            <span>${template.questions.length} questions</span>
                        </div>
                    </div>
                    
                    ${template.jobDescription ? `
                    <div class="template-card-description">
                        ${template.jobDescription.substring(0, 150)}${template.jobDescription.length > 150 ? '...' : ''}
                    </div>
                    ` : ''}
                    
                    <div class="template-card-footer">
                        <small class="text-muted">
                            <i class="fas fa-calendar"></i>
                            Created ${formatDate(template.createdAt || new Date())}
                        </small>
                        <div class="template-card-actions">
                            <button class="btn btn-sm btn-primary" onclick="useTemplate('${template.id}')">
                                <i class="fas fa-play"></i> Use
                            </button>
                            <button class="btn btn-sm btn-secondary" onclick="editTemplate('${template.id}')">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="btn btn-sm btn-light" onclick="deleteTemplate('${template.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        // Use template for interview
        function useTemplate(templateId) {
            const template = templates.find(t => t.id === templateId);
            if (template) {
                // Switch to interviews tab
                switchTab('interviews');
                
                // Populate the form
                document.getElementById('role').value = templateId;
                loadTemplateQuestions();
                
                showToast('Template loaded! Fill in candidate details to create interview.');
            }
        }
        
        // Load AI guidelines
        // Guidelines removed - using optimal defaults
        
        // Guidelines removed - using optimal defaults
        
        // Guidelines removed - using optimal defaults
        
        // Load interviews
        async function loadInterviews() {
            try {
                const response = await fetch('/api/interviews');
                const interviews = await response.json();
                
                updateStats(interviews);
                renderInterviews(interviews);
            } catch (error) {
                console.error('Error loading interviews:', error);
            }
        }
        
        // Update statistics
        function updateStats(interviews) {
            const total = interviews.length;
            const completed = interviews.filter(i => i.status === 'completed').length;
            const pending = interviews.filter(i => i.status === 'pending').length;
            
            animateValue('totalInterviews', 0, total, 1000);
            animateValue('completedInterviews', 0, completed, 1000);
            animateValue('pendingInterviews', 0, pending, 1000);
        }
        
        // Animate number values
        function animateValue(elementId, start, end, duration) {
            const element = document.getElementById(elementId);
            const range = end - start;
            const increment = range / (duration / 16);
            let current = start;
            
            const timer = setInterval(() => {
                current += increment;
                if ((increment > 0 && current >= end) || (increment < 0 && current <= end)) {
                    current = end;
                    clearInterval(timer);
                }
                element.textContent = Math.round(current);
            }, 16);
        }
        
        // Render interviews list
        function renderInterviews(interviews) {
            const container = document.getElementById('interviewsList');
            
            if (!interviews || interviews.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">
                            <i class="fas fa-calendar-plus"></i>
                        </div>
                        <h4>No interviews yet</h4>
                        <p class="text-muted">Create your first interview to get started</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = interviews.map(interview => `
                <div class="interview-item">
                    <div class="interview-info">
                        <div class="interview-name">${interview.candidateName}</div>
                        <div class="interview-details">
                            ${interview.role}  ${formatDate(interview.createdAt || new Date())}
                            ${getStatusBadge(interview.status)}
                        </div>
                    </div>
                    <div class="interview-actions">
                        ${interview.status === 'completed' ? 
                            `<a href="/results/${interview.id}" class="btn btn-sm btn-success">
                                <i class="fas fa-chart-bar"></i> View Results
                            </a>` : 
                            `<button class="btn btn-sm btn-secondary" onclick="copyInterviewLink('${interview.id}')">
                                <i class="fas fa-link"></i> Copy Link
                            </button>`
                        }
                    </div>
                </div>
            `).join('');
        }
        
        // Get status badge
        function getStatusBadge(status) {
            const badges = {
                pending: '<span class="badge badge-warning ml-2">Pending</span>',
                active: '<span class="badge badge-info ml-2">Active</span>',
                completed: '<span class="badge badge-success ml-2">Completed</span>'
            };
            return badges[status] || '';
        }
        
        // Format date
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { 
                month: 'short', 
                day: 'numeric', 
                year: 'numeric' 
            });
        }
        
        // Create interview
        async function createInterview(e) {
            e.preventDefault();
            
            // Collect custom questions
            const questionInputs = document.querySelectorAll('.question-input');
            const customQuestions = Array.from(questionInputs)
                .map(input => input.value.trim())
                .filter(q => q.length > 0);
            
            // Get the actual role name - if template is selected, use the hidden input value
            const roleValue = document.getElementById('roleValue');
            const role = roleValue ? roleValue.value : document.getElementById('role').value;
            
            // Get template data if selected
            const selectedTemplateId = document.getElementById('role').value;
            const selectedTemplate = templates.find(t => t.id === selectedTemplateId);
            
            const formData = {
                candidateName: document.getElementById('candidateName').value,
                candidateEmail: document.getElementById('candidateEmail').value,
                role: role,
                voiceId: document.getElementById('voiceSelect').value,
                customQuestions: customQuestions,
                jobDescription: selectedTemplate?.jobDescription || '',
                templateData: selectedTemplate || null
            };
            
            showLoading();
            
            try {
                const response = await fetch('/api/interviews/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('interviewLink').value = data.interviewUrl;
                    showModal();
                    document.getElementById('createInterviewForm').reset();
                    loadInterviews();
                } else {
                    alert('Error creating interview. Please try again.');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error creating interview. Please try again.');
            } finally {
                hideLoading();
            }
        }
        
        // Test voice function
        async function testVoice() {
            const voiceId = document.getElementById('voiceSelect').value;
            const testText = "Hello! I'm your interviewer from Senbird. Let's have a great conversation today.";
            
            // First ensure we have saved API key
            const elevenLabsKey = document.getElementById('elevenLabsKey').value;
            if (!elevenLabsKey) {
                alert('Please enter your ElevenLabs API key first and save settings.');
                return;
            }
            
            try {
                // Save the API key first
                await fetch('/api/settings/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ elevenlabs_api_key: elevenLabsKey })
                });
                
                // Then test the voice
                const response = await fetch('/api/test-voice', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ voiceId, text: testText })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to test voice');
                }
                
                if (data.audio) {
                    const audio = new Audio(data.audio);
                    audio.volume = 0.8;
                    await audio.play();
                    console.log('Voice test successful');
                } else {
                    throw new Error('No audio data received');
                }
            } catch (error) {
                console.error('Error testing voice:', error);
                alert(error.message || 'Unable to test voice. Please check your ElevenLabs API key.');
            }
        }
        
        // Add question function
        let questionCount = 1;
        function addQuestion() {
            questionCount++;
            const container = document.getElementById('questionsContainer');
            const questionDiv = document.createElement('div');
            questionDiv.className = 'question-item mb-3';
            questionDiv.innerHTML = `
                <label class="form-label">Question ${questionCount}</label>
                <textarea class="form-control question-input" rows="2" 
                          placeholder="Enter your custom question..."></textarea>
                <button type="button" class="remove-question" onclick="removeQuestion(this)">
                    <i class="fas fa-times"></i>
                </button>
            `;
            container.appendChild(questionDiv);
        }
        
        // Remove question function
        function removeQuestion(button) {
            button.parentElement.remove();
            updateQuestionNumbers();
        }
        
        // Update question numbers
        function updateQuestionNumbers() {
            const questions = document.querySelectorAll('.question-item');
            questions.forEach((q, index) => {
                q.querySelector('.form-label').textContent = `Question ${index + 1}`;
            });
            questionCount = questions.length;
        }
        
        // Copy interview link
        async function copyInterviewLink(interviewId) {
            const url = `${window.location.origin}/interview/${interviewId}`;
            await navigator.clipboard.writeText(url);
            showToast('Link copied to clipboard!');
        }
        
        // Copy link from modal
        async function copyLink() {
            const link = document.getElementById('interviewLink').value;
            await navigator.clipboard.writeText(link);
            showToast('Link copied to clipboard!');
        }
        
        // Show/hide loading
        function showLoading() {
            document.getElementById('loadingOverlay').classList.add('active');
        }
        
        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('active');
        }
        
        // Show/hide modal
        function showModal() {
            document.getElementById('successModal').classList.add('active');
            document.body.classList.add('modal-open');
        }
        
        function closeModal() {
            document.getElementById('successModal').classList.remove('active');
            document.body.classList.remove('modal-open');
        }
        
        // Show toast notification
        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            toast.style.cssText = `
                position: fixed;
                bottom: 20px;
                right: 20px;
                background: var(--dark);
                color: var(--white);
                padding: var(--space-sm) var(--space-lg);
                border-radius: var(--radius-full);
                box-shadow: var(--shadow-lg);
                z-index: 3000;
                animation: slideUp var(--transition-base);
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideDown var(--transition-base)';
                setTimeout(() => toast.remove(), 250);
            }, 3000);
        }
        
        // Template Management Functions
        let templates = [];
        let templateQuestionCount = 1;
        
        // Load templates from backend
        async function loadTemplates() {
            try {
                const response = await fetch('/api/templates');
                templates = await response.json();
                updateTemplateDropdown();
                renderTemplates();
                renderTemplateCards();
            } catch (error) {
                console.error('Error loading templates:', error);
                templates = [];
            }
        }
        
        // Save templates is now handled by API calls
        function saveTemplates() {
            // No longer needed - templates are saved via API
            // Keeping function for backward compatibility
            loadTemplates(); // Reload from server
        }
        
        // Update template dropdown
        function updateTemplateDropdown() {
            const select = document.getElementById('role');
            select.innerHTML = '<option value="">Select a position template...</option>';
            
            templates.forEach(template => {
                const option = document.createElement('option');
                option.value = template.id;
                option.textContent = template.position;
                select.appendChild(option);
            });
        }
        
        // Render templates list
        function renderTemplates() {
            const container = document.getElementById('templatesList');
            
            if (templates.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="grid-column: 1/-1; padding: 60px; text-align: center; background: var(--light); border-radius: var(--radius-lg);">
                        <i class="fas fa-folder-open" style="font-size: 4rem; color: var(--dark-20); margin-bottom: 20px; display: block;"></i>
                        <h4>No templates yet</h4>
                        <p class="text-muted">Create your first position template to streamline your interview process</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = templates.map(template => `
                <div class="template-card" onclick="editTemplate('${template.id}')">
                    <div class="template-card-header">
                        <div>
                            <h3 class="template-card-title">${template.position}</h3>
                            ${template.department ? `<span class="badge badge-secondary">${template.department}</span>` : ''}
                        </div>
                    </div>
                    
                    <div class="template-card-meta">
                        ${template.level ? `
                        <div class="template-card-meta-item">
                            <i class="fas fa-layer-group"></i>
                            <span>${getLevelLabel(template.level)}</span>
                        </div>
                        ` : ''}
                        <div class="template-card-meta-item">
                            <i class="fas fa-clock"></i>
                            <span>${template.duration || 30} min</span>
                        </div>
                        <div class="template-card-meta-item">
                            <i class="fas fa-question-circle"></i>
                            <span>${template.questions.length} questions</span>
                        </div>
                    </div>
                    
                    ${template.jobDescription ? `
                    <div class="template-card-description">
                        ${template.jobDescription.substring(0, 150)}${template.jobDescription.length > 150 ? '...' : ''}
                    </div>
                    ` : ''}
                    
                    <div class="template-card-footer">
                        <small class="text-muted">
                            <i class="fas fa-calendar"></i>
                            Created ${formatDate(template.createdAt || new Date())}
                        </small>
                        <div class="template-card-actions">
                            <button class="btn btn-sm btn-secondary" onclick="editTemplate('${template.id}'); event.stopPropagation();">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="btn btn-sm btn-light" onclick="deleteTemplate('${template.id}'); event.stopPropagation();">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        // Get level label
        function getLevelLabel(level) {
            const labels = {
                'entry': 'Entry Level',
                'mid': 'Mid Level',
                'senior': 'Senior Level',
                'lead': 'Lead/Principal',
                'executive': 'Executive'
            };
            return labels[level] || level;
        }
        
        // Show template modal
        function showTemplateModal() {
            document.getElementById('templateModal').classList.add('active');
            document.body.classList.add('modal-open');
        }
        
        // Show create template form directly
        function showCreateTemplateForm() {
            showTemplateModal();
            showCreateTemplate();
        }
        
        // Close template modal
        function closeTemplateModal() {
            document.getElementById('templateModal').classList.remove('active');
            document.body.classList.remove('modal-open');
            cancelTemplateEdit();
        }
        
        // Show create template form
        function showCreateTemplate() {
            // Switch to form view
            document.getElementById('templatesListView').style.display = 'none';
            document.getElementById('templateFormView').style.display = 'block';
            
            // Reset form
            document.getElementById('templateFormTitle').textContent = 'Create New Position Template';
            document.getElementById('editTemplateId').value = '';
            document.getElementById('createTemplateForm').reset();
            
            // Reset questions to one
            templateQuestionCount = 1;
            document.getElementById('templateQuestionsContainer').innerHTML = `
                <div class="question-item mb-3">
                    <div class="d-flex align-items-start gap-2">
                        <span class="question-number" style="background: linear-gradient(135deg, var(--primary), var(--accent-forest)); color: white; padding: 4px 10px; border-radius: var(--radius-full); font-size: 0.875rem; margin-top: 8px;">1</span>
                        <textarea class="form-control template-question-input flex-1" rows="2" required
                              placeholder="Enter interview question..."></textarea>
                </div>
            `;
            templateQuestionCount = 1;
        }
        
        // Add template question
        function addTemplateQuestion() {
            templateQuestionCount++;
            const container = document.getElementById('templateQuestionsContainer');
            const questionDiv = document.createElement('div');
            questionDiv.className = 'question-item mb-3';
            questionDiv.innerHTML = `
                <div class="d-flex align-items-start gap-2">
                    <span class="question-number" style="background: linear-gradient(135deg, var(--primary), var(--accent-forest)); color: white; padding: 4px 10px; border-radius: var(--radius-full); font-size: 0.875rem; margin-top: 8px;">${templateQuestionCount}</span>
                    <textarea class="form-control template-question-input flex-1" rows="2" required
                              placeholder="e.g., Tell me about your experience with [relevant technology/skill]"></textarea>
                    <button type="button" class="btn btn-sm btn-light" onclick="removeTemplateQuestion(this)" style="margin-top: 8px;">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
            container.appendChild(questionDiv);
        }
        
        // Back to templates list
        function backToTemplatesList() {
            document.getElementById('templateFormView').style.display = 'none';
            document.getElementById('templatesListView').style.display = 'block';
        }
        
        // Generate suggested questions based on job description
        async function generateSuggestedQuestions() {
            const jobDescription = document.getElementById('templateJobDescription').value;
            const position = document.getElementById('templatePosition').value;
            const department = document.getElementById('templateDepartment').value;
            const experienceLevel = document.getElementById('templateLevel').value;
            
            if (!position) {
                alert('Please enter a position title first.');
                return;
            }
            
            // Show loading state
            const button = event.target.closest('button');
            const originalText = button.innerHTML;
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
            
            try {
                const response = await fetch('/api/generate-suggestions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        position,
                        department,
                        experienceLevel
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Update job description if empty
                    if (!jobDescription) {
                        document.getElementById('templateJobDescription').value = data.jobDescription;
                    }
                    
                    // Clear existing questions and add suggested ones
                    const container = document.getElementById('templateQuestionsContainer');
                    container.innerHTML = '';
                    
                    data.suggestedQuestions.forEach((question, index) => {
                        const questionDiv = document.createElement('div');
                        questionDiv.className = 'question-item mb-3';
                        questionDiv.innerHTML = `
                            <div class="d-flex align-items-start gap-2">
                                <span class="question-number" style="background: linear-gradient(135deg, var(--primary), var(--accent-forest)); color: white; padding: 4px 10px; border-radius: var(--radius-full); font-size: 0.875rem; margin-top: 8px;">${index + 1}</span>
                                <textarea class="form-control template-question-input flex-1" rows="2" required>${question}</textarea>
                                <button type="button" class="btn btn-sm btn-light" onclick="removeTemplateQuestion(this)" style="margin-top: 8px;">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        `;
                        container.appendChild(questionDiv);
                    });
                    
                    templateQuestionCount = data.suggestedQuestions.length;
                    showToast('Job description and questions generated successfully!');
                } else {
                    alert('Failed to generate suggestions: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error generating suggestions:', error);
                alert('Failed to generate suggestions. Please make sure OpenAI is configured in settings.');
            } finally {
                // Reset button
                button.disabled = false;
                button.innerHTML = originalText;
            }
        }
        
        // Remove template question
        function removeTemplateQuestion(button) {
            button.closest('.question-item').remove();
            updateTemplateQuestionNumbers();
        }
        
        // Update template question numbers
        function updateTemplateQuestionNumbers() {
            const questions = document.querySelectorAll('#templateQuestionsContainer .question-item');
            questions.forEach((q, index) => {
                const numberSpan = q.querySelector('.question-number');
                if (numberSpan) {
                    numberSpan.textContent = index + 1;
                }
            });
            templateQuestionCount = questions.length;
        }
        
        // Save template
        async function saveTemplate(e) {
            e.preventDefault();
            
            const position = document.getElementById('templatePosition').value;
            const jobDescription = document.getElementById('templateJobDescription').value;
            const department = document.getElementById('templateDepartment').value;
            const level = document.getElementById('templateLevel').value;
            const duration = document.getElementById('templateDuration').value;
            
            const questionInputs = document.querySelectorAll('.template-question-input');
            const questions = Array.from(questionInputs)
                .map(input => input.value.trim())
                .filter(q => q.length > 0);
            
            const editId = document.getElementById('editTemplateId').value;
            
            const templateData = {
                position,
                jobDescription,
                department,
                level,
                duration: parseInt(duration) || 30,
                questions
            };
            
            try {
                let response;
                if (editId) {
                    // Update existing template
                    response = await fetch(`/api/templates/${editId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(templateData)
                    });
                } else {
                    // Create new template
                    response = await fetch('/api/templates', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(templateData)
                    });
                }
                
                if (response.ok) {
                    await loadTemplates(); // Reload templates from server
                    showToast('Template saved successfully!');
                    cancelTemplateEdit();
                } else {
                    throw new Error('Failed to save template');
                }
            } catch (error) {
                console.error('Error saving template:', error);
                alert('Failed to save template. Please try again.');
            }
        }
        
        // Edit template
        function editTemplate(templateId) {
            const template = templates.find(t => t.id === templateId);
            if (!template) return;
            
            // Switch to form view
            document.getElementById('templatesListView').style.display = 'none';
            document.getElementById('templateFormView').style.display = 'block';
            
            document.getElementById('templateFormTitle').textContent = 'Edit Position Template';
            document.getElementById('editTemplateId').value = template.id;
            document.getElementById('templatePosition').value = template.position;
            document.getElementById('templateJobDescription').value = template.jobDescription || '';
            document.getElementById('templateDepartment').value = template.department || '';
            document.getElementById('templateLevel').value = template.level || '';
            document.getElementById('templateDuration').value = template.duration || 30;
            
            // Load questions
            const container = document.getElementById('templateQuestionsContainer');
            container.innerHTML = template.questions.map((question, index) => `
                <div class="question-item mb-3">
                    <div class="d-flex align-items-start gap-2">
                        <span class="question-number" style="background: var(--primary); color: white; padding: 4px 10px; border-radius: var(--radius-full); font-size: 0.875rem; margin-top: 8px;">${index + 1}</span>
                        <textarea class="form-control template-question-input flex-1" rows="2" required>${question}</textarea>
                        <button type="button" class="btn btn-sm btn-light" onclick="removeTemplateQuestion(this)" style="margin-top: 8px;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
            
            templateQuestionCount = template.questions.length;
        }
        
        // Delete template
        async function deleteTemplate(templateId) {
            if (confirm('Are you sure you want to delete this template?')) {
                try {
                    const response = await fetch(`/api/templates/${templateId}`, {
                        method: 'DELETE'
                    });
                    
                    if (response.ok) {
                        await loadTemplates(); // Reload templates from server
                        showToast('Template deleted successfully!');
                    } else {
                        throw new Error('Failed to delete template');
                    }
                } catch (error) {
                    console.error('Error deleting template:', error);
                    alert('Failed to delete template. Please try again.');
                }
            }
        }
        
        // Cancel template edit
        function cancelTemplateEdit() {
            document.getElementById('templateFormView').style.display = 'none';
            document.getElementById('templatesListView').style.display = 'block';
            document.getElementById('createTemplateForm').reset();
        }
        
        // Load template questions when selected
        function loadTemplateQuestions() {
            const selectedId = document.getElementById('role').value;
            if (!selectedId) {
                // Clear custom questions
                document.getElementById('questionsContainer').innerHTML = `
                    <div class="question-item mb-3">
                        <label class="form-label">Question 1</label>
                        <textarea class="form-control question-input" rows="2" 
                                  placeholder="Tell me about yourself and your professional background."></textarea>
                    </div>
                `;
                questionCount = 1;
                return;
            }
            
            const template = templates.find(t => t.id === selectedId);
            if (template) {
                // Update role field with template position
                const roleSelect = document.getElementById('role');
                const selectedOption = roleSelect.options[roleSelect.selectedIndex];
                if (selectedOption) {
                    // Create a hidden input to store the actual position name
                    let hiddenInput = document.getElementById('roleValue');
                    if (!hiddenInput) {
                        hiddenInput = document.createElement('input');
                        hiddenInput.type = 'hidden';
                        hiddenInput.id = 'roleValue';
                        roleSelect.parentNode.appendChild(hiddenInput);
                    }
                    hiddenInput.value = template.position;
                }
                
                // Load template questions
                const container = document.getElementById('questionsContainer');
                container.innerHTML = template.questions.map((question, index) => `
                    <div class="question-item mb-3">
                        <label class="form-label">Question ${index + 1}</label>
                        <textarea class="form-control question-input" rows="2">${question}</textarea>
                        ${index > 0 ? `<button type="button" class="remove-question" onclick="removeQuestion(this)">
                            <i class="fas fa-times"></i>
                        </button>` : ''}
                    </div>
                `).join('');
                
                questionCount = template.questions.length;
                showToast('Template questions loaded!');
            }
        }
        
        // Settings Functions
        function showSettingsModal() {
            document.getElementById('settingsModal').classList.add('active');
            document.body.classList.add('modal-open');
        }
        
        function closeSettingsModal() {
            document.getElementById('settingsModal').classList.remove('active');
            document.body.classList.remove('modal-open');
        }
        
        // Load settings from localStorage
        async function loadSettings() {
            try {
                // Check server for configured keys
                const response = await fetch('/api/settings/check');
                const config = await response.json();
                
                // Show placeholders if configured
                if (config.openai) {
                    document.getElementById('openAIKey').placeholder = 'OpenAI API key is configured';
                }
                if (config.elevenlabs) {
                    document.getElementById('elevenLabsKey').placeholder = 'ElevenLabs API key is configured';
                }
            } catch (error) {
                console.error('Error loading settings:', error);
            }
        }
        
        // Save settings
        async function saveSettings(e) {
            e.preventDefault();
            
            const settings = {
                elevenlabs_api_key: document.getElementById('elevenLabsKey').value,
                openai_api_key: document.getElementById('openAIKey').value
            };
            
            // Save to server
            try {
                const response = await fetch('/api/settings/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(settings)
                });
                
                if (response.ok) {
                    showToast('Settings saved successfully!');
                    closeSettingsModal();
                } else {
                    throw new Error('Failed to save settings');
                }
            } catch (error) {
                console.error('Error saving settings:', error);
                alert('Failed to save settings. Please try again.');
            }
        }
        
        // Test API Connection
        async function testAPIConnection(service) {
            const buttonId = service === 'openai' ? 'testOpenAIBtn' : 'testElevenLabsBtn';
            const resultId = service === 'openai' ? 'openaiTestResult' : 'elevenlabsTestResult';
            const button = document.getElementById(buttonId);
            const resultDiv = document.getElementById(resultId);
            
            // Save current settings first
            const apiKey = service === 'openai' 
                ? document.getElementById('openAIKey').value 
                : document.getElementById('elevenLabsKey').value;
                
            if (!apiKey) {
                resultDiv.innerHTML = '<div class="alert alert-warning"><i class="fas fa-exclamation-triangle"></i> Please enter an API key first</div>';
                resultDiv.style.display = 'block';
                return;
            }
            
            // Show loading state
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Testing...';
            
            try {
                // First save the API key
                const settings = {};
                if (service === 'openai') {
                    settings.openai_api_key = apiKey;
                } else {
                    settings.elevenlabs_api_key = apiKey;
                }
                
                await fetch('/api/settings/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(settings)
                });
                
                // Then test the connection
                const response = await fetch('/api/test-connection', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ service })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    resultDiv.innerHTML = `<div class="alert alert-success"><i class="fas fa-check-circle"></i> ${data.message}</div>`;
                } else {
                    resultDiv.innerHTML = `<div class="alert alert-danger"><i class="fas fa-times-circle"></i> ${data.error}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="alert alert-danger"><i class="fas fa-times-circle"></i> Connection test failed: ${error.message}</div>`;
            }
            
            // Reset button
            button.disabled = false;
            button.innerHTML = '<i class="fas fa-plug"></i> Test';
            resultDiv.style.display = 'block';
            
            // Hide result after 5 seconds
            setTimeout(() => {
                resultDiv.style.display = 'none';
            }, 5000);
        }
        
        // Auto refresh every 30 seconds
        setInterval(loadInterviews, 30000);
    </script>
</body>
</html>